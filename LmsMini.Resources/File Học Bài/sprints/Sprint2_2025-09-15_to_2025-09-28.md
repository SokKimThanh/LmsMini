# Sprint 2 — 2025-09-15 → 2025-09-28

Mục tiêu chính

- Thiết lập skeleton dự án theo Clean Architecture và chuẩn hóa conventions.
- Triển khai hạ tầng xác thực/ủy quyền (ASP.NET Identity + JWT + RBAC).
- Cấu hình CI cơ bản, logging, global error handling và DbContext skeleton với audit.

Tổng quan tiến độ (cập nhật theo code hiện tại)

- Trạng thái tổng: một phần đã hoàn thành, nhiều task còn "Not Started".
- Đánh giá hiện tại: ~35% complete (cập nhật thêm tài liệu hướng dẫn và một số tinh chỉnh; code core vẫn ở trạng thái skeleton).

Những gì đã có / Done

- Program.cs: đã đăng ký Serilog, DbContext (LmsDbContext), AutoMapper, MediatR, FluentValidation, Swagger và Serilog request logging.
  - File: `LmsMini.Api/Program.cs`.
- LmsDbContext: tồn tại với nhiều DbSet, cấu hình RowVersion, default value và filtered indexes.
  - File: `LmsMini.Infrastructure/Persistence/LmsDbContext.cs`.
- Domain: AspNetUser entity và mapping có sẵn.
  - File: `LmsMini.Domain/Entities/Identity/AspNetUser.cs`.
- Tài liệu hướng dẫn: đã cập nhật và bổ sung tài liệu liên quan `AccountController` (phiên bản chi tiết và phiên bản cho học sinh) và hướng dẫn lưu secrets an toàn.
  - File: `LmsMini.Resources/File Học Bài/lessons/identity/AccountController_CompleteImplementation.md` (cập nhật).
  - File: `LmsMini.Resources/File Học Bài/lessons/identity/AccountController_For_Kids.md` (mới).
- Kiểm tra build nhanh đã chạy thành công sau chỉnh sửa tài liệu (không thay đổi code thực thi chính).

Những task còn thiếu / Not Started

- Tích hợp ASP.NET Identity runtime (AddIdentity / AddEntityFrameworkStores) trong Program.cs — Not Started.
- JwtService (tạo/validate token), IDateTimeProvider, CurrentUserService chưa có — Not Started.
- Register / Login endpoints (DTO, Command/Handler, Controller) chưa có — Not Started.
- Role seeding (Admin/Instructor/Learner) và admin user seed chưa có — Not Started.
- Migration cho Identity chưa tạo/áp dụng — Not Started.
- Global Error Handling Middleware (Response Envelope) chưa tồn tại — Not Started.
- CI workflow (.github/workflows) chưa có — Not Started.
- Unit / Integration tests cho auth chưa có — Not Started.

Chi tiết trạng thái các task (tương ứng danh sách ban đầu)

1. Tạo solution skeleton & project structure — Done
2. Thiết lập project conventions — Not Started
3. Thiết lập CI (basic) — Not Started
4. Cài đặt package cơ bản — Partially Done (packages đăng ký trong Program.cs nhưng kiểm tra csproj cần)
5. Cấu hình DI & bootstrap (Program.cs) — Done (core services đăng ký)
6. Global Error Handling Middleware — Not Started
7. Logging + correlationId/traceId — Partially Done (Serilog và UseSerilogRequestLogging tồn tại; chưa có correlationId middleware explicit)
8. BaseAuditable & DbContext skeleton — Done (LmsDbContext có audit fields)
9. ASP.NET Identity integration — Not Started (entity có, nhưng runtime integration chưa)
10. EF Core migration initial for Identity — Not Started
11. Repository interfaces for Auth — Not Started
12. IDateTimeProvider & CurrentUserService — Not Started
13. Password/security helpers — Not Started (can use Identity defaults)
14. JWT token service — Not Started
15. Role seeding & admin seed — Not Started
16. Register endpoint — Not Started
17. Login endpoint — Not Started
18. RBAC wiring (policies) — Not Started
19. Unit tests (Auth services) — Not Started
20. Unit tests (Controllers/Handlers) — Not Started
21. Swagger OpenAPI auth docs — Partially Done (Swagger registered with Bearer scheme in Program.cs)

Ưu tiên ngắn hạn (next steps)

1. Đăng ký ASP.NET Identity trong Program.cs và `AddEntityFrameworkStores<LmsDbContext>()`.
2. Tạo migration cho Identity và áp vào local DB (dotnet ef migrations add Init_Identity ...).
3. Thêm JwtService skeleton (create/validate) và cấu hình signing key từ appsettings (hoặc user-secrets).
4. Tạo Register & Login minimal endpoints (DTOs + handler) để test end-to-end.
5. Thêm Role seeder (idempotent) và seed admin.
6. Viết Global Error Middleware đơn giản trả Response Envelope.
7. Tạo file `.github/workflows/ci.yml` mẫu (restore/build/test).

Lệnh tham khảo để dev chạy local

- Cài công cụ EF (nếu cần):
  ```bash
  dotnet tool install --global dotnet-ef
  ```

- Tạo migration (sau khi đã tích hợp Identity):
  ```bash
  dotnet ef migrations add Init_Identity -s LmsMini.Api -p LmsMini.Infrastructure
  ```

- Áp migration vào DB local:
  ```bash
  dotnet ef database update -s LmsMini.Api -p LmsMini.Infrastructure
  ```

- Chạy API local:
  ```bash
  dotnet run --project LmsMini.Api
  ```

Gợi ý phân công & ước lượng ngắn (cho 1 dev)

- Identity + JwtService + Register/Login + Role seed + migration: 2–3 ngày.
- Error middleware, traceId, Serilog fine-tune: 0.5–1 ngày.
- CI workflow + basic tests: 1 ngày.

Ghi chú cho reviewer

- Kiểm tra Program.cs khi thêm Identity: không commit keys; dùng user-secrets cho local.
- Khi tạo migration, review file migration trước khi apply.
- Thêm unit tests nhỏ cho JwtService và handler để đảm bảo behavior.

Muốn tôi tiếp tục thực hiện phần nào ngay bây giờ?
- A: Thêm cấu hình Identity (Program.cs) + migration skeleton
- B: Tạo JwtService + DTOs + Login/Register handler skeleton
- C: Tạo .github/workflows/ci.yml mẫu

Trả lời A/B/C để mình bắt tay thực hiện.