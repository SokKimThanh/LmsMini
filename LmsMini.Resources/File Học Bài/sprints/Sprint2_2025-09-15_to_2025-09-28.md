# Sprint 2 — 2025-09-15 → 2025-09-28

Mục tiêu chính

- Thiết lập skeleton dự án theo Clean Architecture và chuẩn hóa conventions.
- Triển khai hạ tầng xác thực/ủy quyền (ASP.NET Identity + JWT + RBAC).
- Cấu hình CI cơ bản, logging, global error handling và DbContext skeleton với audit.

Tổng quan tiến độ (cập nhật theo code hiện tại)

- Trạng thái tổng: một phần đã hoàn thành; nhiều task trọng yếu vẫn chưa bắt đầu.
- Đánh giá hiện tại: ~60% complete — cơ sở hạ tầng bootstrap, Identity runtime, basic Register/Login endpoints và DB-first scaffolding (entities + DbContext) đã có; còn lại token persistence, seeding và CI/tests cần thực hiện.

Tóm tắt bằng chứng
- Done: bootstrap infra (Serilog, LmsDbContext, AutoMapper, MediatR, FluentValidation, Swagger, Serilog request logging). Domain: `AspNetUser` entity và mapping tồn tại. `Program.cs` đã đăng ký ASP.NET Identity; `AccountController` đã có `Register` và `Login` endpoints (basic JWT creation using configuration). DB-first scaffolding đã được thực hiện và có tài liệu hướng dẫn (`ScaffoldFromDatabase.md`). Build kiểm tra nhanh sau chỉnh sửa tài liệu thành công.
- Missing / High-effort: centralized JwtService (create/validate), IDateTimeProvider, CurrentUserService, refresh-token persistence logic (store/revoke/rotate), role seeding & admin seed, Global Error Handling Middleware, CI workflow, unit/integration tests cho auth.

NOTE: DB-first workflow
- Đây là repo theo hướng DB-first / scaffolding: team sẽ không áp dụng các migrations code->DB. Thay vào đó, scaffold (reverse-engineer) các entity/DbContext từ schema hiện có nếu cần cập nhật code. Các lệnh `dotnet ef migrations` được giữ làm tham khảo nhưng không bắt buộc; consider them optional references only.

Những gì đã có / Done

- Program.cs: đăng ký Serilog, DbContext (LmsDbContext), AutoMapper, MediatR, FluentValidation, Swagger, Serilog request logging, và đã đăng ký Identity runtime (AddIdentity + AddEntityFrameworkStores).
  - File: `LmsMini.Api/Program.cs`.
- LmsDbContext: tồn tại với nhiều DbSet, cấu hình RowVersion, default value và filtered indexes.
  - File: `LmsMini.Infrastructure/Persistence/LmsDbContext.cs`.
- Domain: `AspNetUser` entity và mapping có sẵn.
  - File: `LmsMini.Domain/Entities/Identity/AspNetUser.cs`.
- AccountController: basic `Register` và `Login` endpoints implemented (creates user, validates password, issues JWT using `Jwt:Key` from configuration).
  - File: `LmsMini.Api/Controllers/AccountController.cs`.
- Scaffolding: Entities and `LmsDbContext` scaffolded from database and documented.
  - File: `LmsMini.Resources/File Học Bài/architecture/libraries/ScaffoldFromDatabase.md` (Status: ✅ Completed).
- Tài liệu hướng dẫn: `AccountController_CompleteImplementation.md` (chi tiết) và `AccountController_For_Kids.md` (phiên bản đơn giản).
  - File: `LmsMini.Resources/File Học Bài/lessons/identity/AccountController_CompleteImplementation.md`.
  - File: `LmsMini.Resources/File Học Bài/lessons/identity/AccountController_For_Kids.md`.
- Kiểm tra build: nhanh đã chạy thành công sau chỉnh sửa tài liệu.

Những task còn thiếu / Not Started hoặc Partially Done

- JwtService (create/validate) as a dedicated service — Not Started.
- IDateTimeProvider, CurrentUserService — Not Started.
- RefreshToken entity & persistence (store/revoke/rotate) — Partially Done (entity scaffolded from DB as part of DB-first, persistence logic not yet implemented).
- Role seeding (Admin/Instructor/Learner) và admin user seed — Not Started.
- Global Error Handling Middleware (Response Envelope) — Not Started.
- CI workflow (.github/workflows) — Not Started.
- Unit / Integration tests cho auth — Not Started.
- Swagger OpenAPI auth docs — Partially Done (Bearer scheme đăng ký).

Chi tiết trạng thái các task (cập nhật)

1. Tạo solution skeleton & project structure — Done  
2. Thiết lập project conventions — Not Started  
3. Thiết lập CI (basic) — Not Started  
4. Cài đặt package cơ bản — Partially Done (đã đăng ký trong Program.cs; kiểm tra csproj cần)  
5. Cấu hình DI & bootstrap (Program.cs) — Done (core services đăng ký)  
6. Global Error Handling Middleware — Not Started  
7. Logging + correlationId/traceId — Partially Done (Serilog + UseSerilogRequestLogging; chưa có middleware correlationId explicit)  
8. BaseAuditable & DbContext skeleton — Done  
9. ASP.NET Identity integration — Done  
10. EF Core migration initial for Identity — Not Applicable (DB-first)  
11. Repository interfaces for Auth — Not Started  
12. IDateTimeProvider & CurrentUserService — Not Started  
13. Password/security helpers — Not Started (can use Identity defaults)  
14. JWT token service — Not Started (token currently created inline in controller; extract to service needed)  
15. Role seeding & admin seed — Not Started  
16. Register endpoint — Done  
17. Login endpoint — Done  
18. RBAC wiring (policies) — Not Started  
19. Unit tests (Auth services) — Not Started  
20. Unit tests (Controllers/Handlers) — Not Started  
21. Swagger OpenAPI auth docs — Partially Done

Ưu tiên ngắn hạn (Next steps — recommended order)

1. Extract inline JWT creation into a `JwtService` (create/validate) and register it in DI; read signing key from user-secrets / env.
2. Implement RefreshToken persistence logic (store/revoke/rotate) using scaffolded entity and integrate into `AccountController` (refresh / logout flows).
3. Tạo `RoleSeeder` idempotent (Admin/Instructor/Learner) and seed admin; call after `builder.Build()`.
4. Viết Global Error Middleware trả Response Envelope (ổn định API surface).
5. Tạo `.github/workflows/ci.yml` mẫu (restore/build/test) và chạy pipeline thử nghiệm.
6. Viết unit/integration tests nhỏ cho JwtService và Account flows (mock IEmailSender, in-memory DB).

Gợi ý ước lượng (1 dev)

- Extract JwtService + RefreshToken persistence + Role seed + scaffolding merge: 2–3 ngày.  
- Error middleware, correlationId, Serilog fine-tune: 0.5–1 ngày.  
- CI workflow + basic tests: 1 ngày.

Checklist hành động (quick)

- [x] Implement basic `Register` endpoint in `AccountController`.  
- [x] Implement basic `Login` endpoint in `AccountController` (issues JWT using configuration).  
- [x] AddIdentity + AddEntityFrameworkStores trong `Program.cs`.  
- [x] Scaffolding guide & entities (`ScaffoldFromDatabase.md`) — Completed.  
- [ ] Extract JwtService + register in DI.  
- [ ] Implement `RefreshToken` persistence logic (use scaffolded entity).  
- [ ] Register/Login endpoints: persist refresh token and support refresh/logout.  
- [ ] RoleSeeder & optional AdminSeeder.  
- [ ] Global Error Middleware.  
- [ ] CI workflow file.  
- [ ] Unit/integration tests cho auth flows.

Ghi chú cho reviewer

- Project uses DB-first approach: do not apply code-based EF migrations to database. Instead scaffold entities/DbContext from the current DB schema when updating code. The `dotnet ef migrations` commands are kept as reference but are optional.
- `AccountController` currently creates JWT inline using `Jwt:Key` from configuration; recommend extracting to a reusable `JwtService` and using `UserManager`/`RoleManager` where appropriate.
- Khi thao tác với DB: luôn backup trước; KHÔNG commit secrets; dùng user-secrets hoặc environment variables.
- Kiểm tra scaffold output và merge with existing custom `AspNetUser` implementation carefully.

Muốn tôi thực hiện phần nào tiếp theo?
- A: Implement `RefreshToken` persistence logic + update `AccountController` refresh/logout flows
- B: Tạo `JwtService` và refactor `AccountController` để dùng service
- C: Tạo `RoleSeeder` + seed admin

Trả lời A / B / C để mình bắt tay thực hiện.