# Nhật ký công việc — 2025-09-07

Tóm tắt ngắn các việc đã thực hiện hôm nay:

- Quyết định chiến lược: giữ database-first cho phần Identity (bảng AspNet* do DBA/DB quản lý).
- Chuyển các lớp scaffolded Identity để tương thích với Identity API:
  - AspNetUser : IdentityUser<Guid>
  - AspNetRole : IdentityRole<Guid>
  - AspNetUserClaim/Login/Token : kế thừa IdentityUserClaim<Guid>/IdentityUserLogin<Guid>/IdentityUserToken<Guid>
  - AspNetRoleClaim : IdentityRoleClaim<Guid>
- Cập nhật LmsDbContext:
  - Kế thừa IdentityDbContext với generic phù hợp (TUser/TRole và các claim/login/token types).
  - Loại bỏ UsingEntity<Dictionary<...>> nhiều-nhiều thủ công cho AspNetUserRoles để tránh duplicate mapping.
  - Tách các mapping idempotent (ToTable, HasMaxLength, v.v.) vào `LmsDbContext.Custom.cs` (partial) để scaffold không ghi đè.
- Đồng bộ Program.cs:
  - Đăng ký Identity bằng `AddIdentity<AspNetUser, AspNetRole>()` và `AddEntityFrameworkStores<LmsDbContext>()`.
  - Bổ sung `app.UseAuthentication()` trước `app.UseAuthorization()`.
  - Thêm seeder roles an toàn (RoleManager<AspNetRole>).
- Kiểm tra & build:
  - Đã chạy `dotnet build` nhiều lần — build thành công.

Các file chính đã thay đổi:
- LmsMini.Infrastructure/Persistence/LmsDbContext.cs
- LmsMini.Infrastructure/Persistence/LmsDbContext.Custom.cs
- LmsMini.Domain/Entities/Identity/AspNetUser.cs
- LmsMini.Domain/Entities/Identity/AspNetRole.cs
- LmsMini.Domain/Entities/Identity/AspNetUserClaim.cs
- LmsMini.Domain/Entities/Identity/AspNetUserLogin.cs
- LmsMini.Domain/Entities/Identity/AspNetUserToken.cs
- LmsMini.Domain/Entities/Identity/AspNetRoleClaim.cs
- LmsMini.Api/Program.cs

Kết quả hiện tại:
- Mô hình Identity đồng nhất, tránh lỗi duplicate mapping (AspNetUserRoles, AspNetRoleClaims, ...).
- Ứng dụng biên dịch thành công; sẵn sàng chạy để kiểm thử end-to-end (register/login, role seeding).

Next steps (khuyến nghị ngắn):
1. Chạy app: `dotnet run --project LmsMini.Api` và kiểm thử endpoints register/login qua Swagger/Postman.
2. Kiểm tra bảng DB: AspNetUsers, AspNetRoles, AspNetUserRoles có dữ liệu mong đợi.
3. Thêm CI check để chặn migration ảnh hưởng AspNet* (nếu chưa có).
4. Khi re-scaffold, scaffold vào thư mục tạm và merge; không scaffold ghi đè `LmsDbContext.Custom.cs`.

UPDATE: Hủy toàn bộ quy trình DB‑first cho phần Identity — chuyển hoàn toàn sang chiến lược Code‑First.
- Lý do: tránh phức tạp và lỗi duplicate mapping khi scaffold các bảng AspNet*.
- Hành động: dừng quy trình scaffold/merge cho các bảng AspNet*, giữ các lớp Identity kế thừa trực tiếp các kiểu Identity và để IdentityDbContext quản lý mapping.

Ghi chú: file này là nhật ký tóm tắt. Nếu cần bản chi tiết/log commit, có thể tạo thêm changelog hoặc PR notes.
